// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt and http://www.arcgis.com/apps/webappbuilder/copyright.txt for details.
//>>built
define(["dojo/_base/lang","dojo/_base/html","dojo/query","dojo/keys","dojo/on"],function(g,d,h,f,k){var e={firstFocusNodeClass:"firstFocusNode",lastFocusNodeClass:"lastFocusNode",isInNavMode:function(){return d.hasClass(document.body,"jimu-nav-mode")?!0:!1},initTabIndexAndOrder:function(a){var b=e.getFirstFocusNode(a.domNode,a.inPanel),c=e.getLastFocusNode(a.domNode);b&&!c&&(c=b);a.isController&&(b=c=null);e.initFirstFocusNode(a.domNode,b);e.initLastFocusNode(a.domNode,c)},isCommonOnScreenWidget:function(a){return a.isOnScreen&&
!a.inPanel&&!0!==a.closeable},preventMapNavigation:function(a){0<=[f.NUMPAD_PLUS,61,187,f.NUMPAD_MINUS,173,189,f.UP_ARROW,f.NUMPAD_8,f.RIGHT_ARROW,f.NUMPAD_6,f.DOWN_ARROW,f.NUMPAD_2,f.LEFT_ARROW,f.NUMPAD_4,f.PAGE_UP,f.NUMPAD_9,f.PAGE_DOWN,f.NUMPAD_3,f.END,f.NUMPAD_1,f.HOME,f.NUMPAD_7].indexOf(a.keyCode)&&a.stopPropagation()},_addAttrsOnWidgetDom:function(a){var b=0<=["MyLocation","HomeButton","FullScreen"].indexOf(a.name)?"button":"application";a.inPanel||d.setAttr(a.domNode,"role",b)},initWidgetCancelEvent:function(a){this._addAttrsOnWidgetDom(a);
k(a.domNode,"keydown",g.hitch(this,function(b){e.preventMapNavigation(b);var c=b.target;if(!(a.inPanel||0>[f.ENTER,f.ESCAPE].indexOf(b.keyCode)))if(e.isCommonOnScreenWidget(a))if(b.keyCode===f.ENTER&&d.hasClass(c,a.baseClass))b.preventDefault(),e.focusFirstFocusNode(a.domNode);else{if(b.keyCode===f.ESCAPE)if(!d.hasClass(c,a.baseClass))b.stopPropagation(),a.domNode.focus();else if("Splash"!==a.name||"none"===d.getStyle(a.domNode,"display"))c=a.domNode.parentNode,"map"===d.getAttr(c,"id")?(b.preventDefault(),
c.focus()):(b="jimu-layout-manager"===d.getAttr(c,"id")?a.domNode:a.domNode.parentNode,e.trapToNextFocusContainer(b,!1))}else b.keyCode!==f.ESCAPE||d.hasClass(c,a.baseClass)||(a.domNode.focus(),a.onClose(),b.preventDefault(),b.stopPropagation())}))},initFirstFocusNode:function(a,b){var c=e.getFirstFocusNode(a);c&&(d.removeClass(c,e.firstFocusNodeClass),c.firstNodeEvent&&c.firstNodeEvent.remove(),c===a&&(d.setAttr(c,"tabindex",null),d.setAttr(c,"role","")));b&&(b===a&&(d.setAttr(b,"tabindex",0),d.setAttr(b,
"role","document")),d.addClass(b,e.firstFocusNodeClass),b.firstNodeEvent=k(b,"keydown",g.hitch(this,function(b){if(d.hasClass(b.target,e.firstFocusNodeClass)&&b.keyCode===f.TAB)if(window.currentMsgPopup&&window.currentMsgPopup.firstFocusNode)window.currentMsgPopup.focusedNodeBeforeOpen=b.target,b.preventDefault(),window.currentMsgPopup.firstFocusNode.focus();else{var c=h(".jimu-widget-splash",h("#jimu-layout-manager")[0])[0];c&&"none"!==d.getStyle(c,"display")&&c!==a?(b.preventDefault(),h("."+e.firstFocusNodeClass,
c)[0].focus()):b.shiftKey&&(b.preventDefault(),b=e.getLastFocusNode(a),e.isDomFocusable(b)?b.focus():e.getFocusNodesInDom(b)[0].focus())}})))},initLastFocusNode:function(a,b){var c=e.getLastFocusNode(a);c&&(d.removeClass(c,e.lastFocusNodeClass),c.lastNodeEvent&&c.lastNodeEvent.remove(),c===a&&d.setAttr(c,"tabindex",null));b&&(b===a&&d.setAttr(b,"tabindex",0),d.addClass(b,e.lastFocusNodeClass),b.lastNodeEvent=k(b,"keydown",g.hitch(this,function(c){if(!c.shiftKey&&c.keyCode===f.TAB)if(a===b)c.preventDefault(),
this.focusFirstFocusNode(a);else{var l=this.getFocusNodesInDom(b);0===l.length?(c.preventDefault(),this.focusFirstFocusNode(a)):d.hasClass(c.target,e.lastFocusNodeClass)||l[l.length-1]!==c.target||(c.preventDefault(),this.focusFirstFocusNode(a))}})))},focusFirstFocusNode:function(a){var b=h("."+e.firstFocusNodeClass,a)[0];(b?b:a).focus()},getFirstFocusNode:function(a,b){var c=d.hasClass(a,e.firstFocusNodeClass)?a:h("."+e.firstFocusNodeClass,a)[0];!c&&b&&(c=a,null===d.getAttr(c,"tabindex")&&d.setAttr(c,
"tabindex","0"));return c},getLastFocusNode:function(a){return d.hasClass(a,e.lastFocusNodeClass)?a:h("."+e.lastFocusNodeClass,a)[0]},traversalDom:function(a,b){b=b?b:[];for(var c=a.childNodes,d=0;d<c.length;d++)a=c[d],1===a.nodeType&&(b.push(a),e.traversalDom(a,b));return b},getFocusNodesInDom:function(a){a=e.traversalDom(a);for(var b=[],c=0;c<a.length;c++){var d=a[c];e.isDomFocusable(d)&&b.push(d)}return b},isDomFocusable:function(a){var b=["A","INPUT","BUTTON","SELECT","TEXTAREA"],c="presentation"!==
d.getAttr(a,"role"),e="hidden"!==d.getAttr(a,"type"),f=!0!==d.getAttr(a,"disabled"),h=parseInt(d.getAttr(a,"tabindex"),10);return c&&e&&f&&(0<=b.indexOf(a.tagName)&&-1!==h||0>b.indexOf(a.tagName)&&0<=h)?!0:!1},trapToNextFocusContainer:function(a,b){for(var c=a.parentNode.children,e=[],f=0;f<c.length;f++){var g=c[f];0<parseInt(d.getAttr(g,"tabindex"),10)&&"none"!==d.getStyle(g,"display")&&e.push(g)}e.sort(function(a,b){a=parseInt(d.getAttr(a,"tabindex"),10);b=parseInt(d.getAttr(b,"tabindex"),10);return a<
b?-1:a===b?0:1});c=null;if(b)c=e[0];else if("none"===d.getStyle(a,"display"))c=e[0];else for(a=parseInt(d.getAttr(a,"tabindex"),10),b=0;b<e.length;b++)if(parseInt(d.getAttr(e[b],"tabindex"),10)===a){c=b===e.length-1?e[0]:e[b+1];break}c||(c=h("#skipContainer a")[0]);c.focus();return c},_getTooltipLabel:function(a,b){var c=d.getAttr(a,"aria-label");a=d.getAttr(a,"title");return c||a||b},focusFirstFocusByTheme:function(a,b){var c=a.appConfig.theme.name;"DashboardTheme"===c&&a.isOnScreen&&"widgetOnScreen"!==
a.gid||"JewelryBoxTheme"===c&&a.panel&&a.panel.uri&&a.panel.uri.includes("LDockablePanel")||(!a.openAtStart||a._isNotOpenAtStart&&!a.openAtStartAysn)&&b.focus()},addTooltipByDomNode:function(a,b,c){a.defaultPosition=["below-centered","above-centered","after-centered","before-centered"];var f;k(b,"focus",g.hitch(this,function(g){e.isInNavMode()&&(f&&d.setAttr(f,"role","presentation"),a.show(e._getTooltipLabel(b,c)+"\x26nbsp;\x26nbsp;",g.target),f||(f=h(".dijitTooltipContainer",document.body)[0],d.setAttr(f,
"role","presentation")))}));k(b,"blur",g.hitch(this,function(b){a&&a.hide(b.target)}))}};return e});