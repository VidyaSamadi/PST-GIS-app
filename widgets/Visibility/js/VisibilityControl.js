// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt and http://www.arcgis.com/apps/webappbuilder/copyright.txt for details.
//>>built
require({cache:{"url:widgets/Visibility/templates/VisibilityControl.html":'\x3cdiv data-dojo-attach-point\x3d"visibiltyWidget"\x3e\r\n  \x3clabel data-dojo-attach-point\x3d"errorText" style\x3d"display: none"\x3e\x3c/label\x3e\r\n  \x3cdiv class\x3d"controls" data-dojo-attach-point\x3d"controls"\x3e\r\n    \x3cdiv class\x3d"controlGroup"\x3e\r\n      \x3cdiv data-dojo-attach-point\x3d"observerCoordsContainer"\x3e\x3c/div\x3e\r\n    \x3c/div\x3e\r\n    \x3cdiv class\x3d"controlGroup"\x3e\r\n      \x3clabel class\x3d"titleLabel" data-dojo-attach-point\x3d"FOVLabel"\x3e${nls.fieldOfView}\x3c/label\x3e\r\n      \x3cdiv class\x3d"center" data-dojo-attach-point\x3d"FOVGroup"\x3e\r\n        \x3cinput type\x3d"text" value\x3d"360" class\x3d"fov" data-displayInput\x3d"true" data-cursor\x3d"true" disabled\x3d"true"\r\n          data-dojo-attach-point\x3d"FOVInput" /\x3e\r\n        \x3cp class\x3d"cursortooltip" data-dojo-attach-point\x3d"tooltip" hidden\x3d\'true\'\x3e\x3c/p\x3e\r\n      \x3c/div\x3e\r\n    \x3c/div\x3e\r\n    \x3cdiv class\x3d"controlGroup"\x3e\r\n      \x3cinput class\x3d"switch-toggle" data-dojo-type\x3d"dijit/form/CheckBox" data-dojo-attach-point\x3d"angleUnits" checked\x3d"false" /\x3e\r\n      \x3clabel class\x3d"titleLabel"\x3e${nls.useMilsText}\x3c/label\x3e\r\n    \x3c/div\x3e\r\n    \x3cdiv class\x3d"controlGroup"\x3e\r\n      \x3clabel class\x3d"titleLabel"\x3e${nls.observerHeight}\x3c/label\x3e\r\n      \x3cdiv\x3e\r\n        \x3cinput class\x3d"inputNumberTextbox" data-dojo-type\x3d\'dijit/form/NumberTextBox\' required\x3d"true" value\x3d"2"\r\n          data-dojo-props\x3d\'\r\n          constraints: {min: 0},\r\n          invalidMessage: "${nls.invalidMessage}",\r\n          rangeMessage: "${nls.observerRangeMessage}"\'\r\n          data-dojo-attach-point\x3d"observerHeight"\x3e\r\n        \x3cselect style\x3d"width: 100px" class\x3d"controlSpace noResize" data-dojo-type\x3d"dijit/form/Select"\r\n          data-dojo-attach-point\x3d"observerHeightDD"\x3e\r\n        \x3c/select\x3e\r\n      \x3c/div\x3e\r\n    \x3c/div\x3e\r\n    \x3cdiv class\x3d"controlGroup"\x3e\r\n      \x3clabel class\x3d"titleLabel"\x3e${nls.minObsDistance}\x3c/label\x3e\r\n      \x3cdiv\x3e\r\n        \x3cinput class\x3d"inputNumberTextbox" data-dojo-type\x3d\'dijit/form/NumberTextBox\' required\x3d"true" value\x3d"3"\r\n          data-dojo-props\x3d\'constraints: {min: 0}\' data-dojo-attach-point\x3d"minObsRange"\x3e\r\n        \x3cselect style\x3d"width: 100px" class\x3d"controlSpace noResize" data-dojo-type\x3d"dijit/form/Select"\r\n          data-dojo-attach-point\x3d"distanceUnitDD"\x3e\r\n        \x3c/select\x3e\r\n      \x3c/div\x3e\r\n    \x3c/div\x3e\r\n    \x3cdiv class\x3d"controlGroup"\x3e\r\n      \x3clabel class\x3d"titleLabel"\x3e${nls.maxObsDistance}\x3c/label\x3e\r\n      \x3cdiv\x3e\r\n        \x3cinput class\x3d"inputNumberTextbox" data-dojo-type\x3d\'dijit/form/NumberTextBox\' required\x3d"true" value\x3d"5"\r\n          data-dojo-props\x3d\'constraints: {min: 0}\' data-dojo-attach-point\x3d"maxObsRange"\x3e\r\n      \x3c/div\x3e\r\n    \x3c/div\x3e\r\n    \x3cdiv class\x3d"buttonContainer" data-dojo-attach-point\x3d"buttonContainer"\x3e\r\n      \x3cdiv class\x3d"btnContainer HalfWidthLeft"\x3e\r\n        \x3cdiv class\x3d"jimu-btn" data-dojo-attach-point\x3d"btnCreate"\x3e${nls.createBtn}\x3c/div\x3e\r\n      \x3c/div\x3e\r\n      \x3cdiv class\x3d"btnContainer HalfWidthRight"\x3e\r\n        \x3cdiv class\x3d"jimu-btn controlSpace" data-dojo-attach-point\x3d"btnClear"\x3e${nls.clearBtn}\x3c/div\x3e\r\n      \x3c/div\x3e\r\n    \x3c/div\x3e\r\n  \x3c/div\x3e\r\n\x3c/div\x3e'}});
define("dojo/_base/declare dojo/_base/kernel dojo/_base/event dojo/Deferred dojo/_base/lang dojo/_base/array dojo/on dojo/number dojo/string dojo/dom-style dojo/mouse dojo/promise/all dijit/_WidgetBase dijit/_TemplatedMixin dijit/_WidgetsInTemplateMixin dojo/text!../templates/VisibilityControl.html jimu/dijit/Message esri/dijit/util/busyIndicator esri/graphic esri/layers/GraphicsLayer esri/tasks/FeatureSet esri/graphicsUtils esri/symbols/SimpleFillSymbol esri/symbols/SimpleLineSymbol esri/symbols/SimpleMarkerSymbol esri/renderers/SimpleRenderer esri/Color esri/dijit/analysis/CreateViewshed esri/layers/FeatureLayer esri/geometry/Polygon esri/geometry/geometryEngine ./geometryUtils jimu/dijit/CoordinateControl ./util dijit/form/NumberTextBox jimu/dijit/CheckBox ./jquery.knob.min".split(" "),
function(y,B,C,v,c,l,e,D,E,m,r,F,G,H,I,J,w,K,n,z,L,A,t,g,M,N,h,O,P,x,p,q,Q,R){return y([G,H,I],{templateString:J,baseClass:"jimu-widget-visibility-control",FOV:180,LA:180,map:null,constructor:function(a){y.safeMixin(this,a);this.nls=a.nls},postCreate:function(){var a=[],b;l.forEach("meters kilometers miles feet yards nauticalMiles".split(" "),c.hitch(this,function(d){b={value:d,label:window.jimuNls.units[d]};a.push(b)}));this.observerHeightDD.addOption(a);this.utils=new R({appConfig:this.appConfig,
nls:this.nls});this.distanceUnitDD.addOption(c.clone(a));this.observerHeightDD.set("value",this.config.defaultObserverHeightUnit);this.distanceUnitDD.set("value",this.config.defaultObservableDistanceUnit);this.angleUnits.setValue(this.config.defaultAngleUnits);if(this.portalUrl){this._setUpSymbology();var d=new N(this._ptSym);this._observerLocation=new z({id:"observerLocation"});this._observerLocation.spatialReference=this.map.spatialReference;this._observerLocation.setRenderer(d);this.map.addLayer(this._observerLocation);
this.distanceUnit=this.distanceUnitDD.get("value");this.observerHeightUnit=this.observerHeightDD.get("value");this.inputControl=new Q({parentWidget:this.parentWidget,label:this.nls.observerLocation,input:!0,showCopyButton:!1,showFormatButton:!0,showDrawPoint:!0,drawButtonLabel:this.nls.addPointToolTip,graphicsLayer:this._observerLocation});this.inputControl.placeAt(this.observerCoordsContainer);this.inputControl.startup();this._initGL();this._syncEvents();this.minObsRange.invalidMessage=this.nls.invalidMessage;
this.minObsRange.rangeMessage=this.nls.minimumRangeMessage;this.maxObsRange.invalidMessage=this.nls.invalidMessage;this.maxObsRange.rangeMessage=this.nls.maximumRangeMessage}else this._showPortalURLError(this.nls.portalURLError);this.resetInputColor()},startup:function(){this.busyIndicator=K.create({target:this.domNode.parentNode.parentNode.parentNode,backgroundOpacity:0});this.FOVInput.id="fovinput"+this.parentWidget.id;var a=c.hitch(this,function(a,d,f){this.LA=this.angleUnits.checked?a/17.777777777778:
a;this.FOV=Math.round(d);this.tooltip.innerHTML=360===f&&this.angleUnits.checked?$("#"+this.FOVInput.id).val()+" "+this.nls.milsLabel:this.angleUnits.checked?f+" "+this.nls.milsLabel:f+" "+this.nls.degreesLabel});$("#"+this.FOVInput.id).knob({min:0,max:360,cursor:360,width:160,height:160,draw:function(){a(this.v,this.o.cursor,this.cv);window.isRTL&&this.i.css({"margin-right":"-"+(3*this.w/4+2>>0)+"px","margin-left":"auto"})}})},destroy:function(){this.map.removeLayer(this._observerLocation);this.map.removeLayer(this.graphicsLayer)},
_showPortalURLError:function(a){m.set(this.controls,"display","none");m.set(this.buttonContainer,"display","none");this.errorText.innerHTML=a;m.set(this.errorText,"display","")},_setUpSymbology:function(){this._ptSym=new M(this.pointSymbol);this.visibleArea=new t;this.visibleArea.setOutline(new g(g.STYLE_SOLID,new h([0,0,0,0]),1));this.visibleArea.setColor(new h([0,255,0,.5]));this.notVisibleArea=new t;this.notVisibleArea.setOutline(new g(g.STYLE_SOLID,new h([0,0,0,0]),1));this.notVisibleArea.setColor(new h([255,
0,0,.5]));this.fullWedge=new t;this.fullWedge.setOutline(new g(g.STYLE_DASH,new h([0,0,0,1]),1));this.fullWedge.setColor(new h([0,0,0,0]));this.wedge=new t;this.wedge.setOutline(new g(g.STYLE_SOLID,new h([255,0,0,1]),1));this.wedge.setColor(new h([0,0,0,0]))},_initGL:function(){this.graphicsLayer=new z;this.graphicsLayer.name="Viewshed Layer";this.map.addLayer(this.graphicsLayer)},_syncEvents:function(){this.own(e(this.btnCreate,"click",c.hitch(this,this.createButtonWasClicked)),e(this.btnClear,"click",
c.hitch(this,this.onClearBtnClicked)),e(this.minObsRange,"keyup",c.hitch(this,this.minObsRangeKeyWasPressed)),e(this.FOVInput,"mousemove",c.hitch(this,this.mouseMoveOverFOVInput)),e(this.FOVInput,r.leave,c.hitch(this,this.mouseMoveOutFOVInput)),e(this.FOVGroup,r.leave,c.hitch(this,function(){this.tooltip.hidden=!0})),e(this.FOVGroup,r.enter,c.hitch(this,this.mouseMoveOverFOVGroup)),e(this.FOVInput,r.enter,c.hitch(this,function(){this.tooltip.hidden=!0})),e(this.FOVInput,"keypress",c.hitch(this,function(a){isNaN(a.key)&&
13!==a.charCode&&C.stop(a)})),this.angleUnits.on("change",c.hitch(this,this.angleUnitsDidChange)),this.observerHeightDD.on("change",c.hitch(this,this.distanceUnitDDDidChange)),this.distanceUnitDD.on("change",c.hitch(this,this.distanceUnitDDDidChange)),e(this.inputControl.dt,"DrawComplete",c.hitch(this,this.feedbackDidComplete)),e(this.inputControl,"get-coordinate-complete",c.hitch(this,this.feedbackDidComplete)))},minObsRangeKeyWasPressed:function(){this.minObsRange.isValid()&&(this.maxObsRange.constraints.min=
Number(this.minObsRange.displayedValue)+.001,this.maxObsRange.set("value",Number(this.minObsRange.displayedValue)+1))},mouseMoveOverFOVGroup:function(){!1===this.FOVInput.disabled&&(this.mouseMoveOverFOVInput(),this.tooltip.hidden=!1)},mouseMoveOverFOVInput:function(){var a=this.tooltip;!1===this.FOVInput.disabled&&$(document).ready(function(){$(document).mousemove(function(b){m.set(a,{left:b.pageX+10+"px",top:b.pageY+10+"px"})})})},mouseMoveOutFOVInput:function(){this.tooltip.hidden=!1;this.FOVInput.blur()},
angleUnitsDidChange:function(){this.angleUnits.checked?($("#"+this.FOVInput.id).trigger("configure",{max:6400,units:"mils",milsValue:6400}),$("#"+this.FOVInput.id).val(6400).trigger("change")):($("#"+this.FOVInput.id).trigger("configure",{max:360,units:"degrees",milsValue:6400}),$("#"+this.FOVInput.id).val(360).trigger("change"));this.resetInputColor()},distanceUnitDDDidChange:function(){var a="",b={};this.distanceUnit=this.distanceUnitDD.get("value");this.observerHeightUnit=this.observerHeightDD.get("value");
if(this.distanceUnit){switch(this.distanceUnit){case "miles":b.max=31;break;case "nauticalMiles":b.max=26.9383;break;case "kilometers":b.max=50;break;case "yards":b.max=54680;break;case "feet":b.max=164041;break;case "meters":b.max=5E4}a=E.substitute(this.nls.maximumRangeMessage,{units:window.jimuNls.units[this.distanceUnit],limit:D.format(b.max,{places:2,locale:B.locale})});b.min=Number(this.minObsRange.displayedValue)+.001;this.maxObsRange.set("constraints",b);this.maxObsRange.set("rangeMessage",
a)}},feedbackDidComplete:function(){this.inputControl.deactivateDrawTool();this.map.enableMapNavigation();this.enableFOVDial()},enableFOVDial:function(){this.FOVInput.disabled&&(this.FOVInput.disabled=!1,$("#"+this.FOVInput.id).trigger("configure",{fgColor:"#00ff66",bgColor:"#f37371",inputColor:"#ccc"}));this.resetInputColor()},_createWedgesUsingBuffers:function(a,b,d,f){b=A.getGeometries(b);f=p.geodesicBuffer(b,[f],"meters",!0);0<d?(d=p.geodesicBuffer(b,[d],"meters",!0),f=p.difference(f[0],d[0])):
f=f[0];a.resolve([f,f])},_createWedgesUsingAngles:function(a,b,d,f,c,u){var k,e,g;b=b.geometry;k=[];e=[];d=d>f?d-360:d;u=q.getPointsForArc(d,f,b,u);e.push([b.x,b.y]);l.forEach(u,function(a){e.push([a.x,a.y])});e.push([b.x,b.y]);0<c?(g=q.getDestinationPoint(b,d,c),d=q.getPointsForArc(d,f,b,c),k.push([g.x,g.y]),l.forEach(u,function(a){k.push([a.x,a.y])}),d.reverse(),l.forEach(d,function(a){k.push([a.x,a.y])}),k.push([g.x,g.y])):k=e;d=new x(k);d.setSpatialReference(b.spatialReference);f=new x(e);f.setSpatialReference(b.spatialReference);
a.resolve([d,f])},_createWedges:function(a,b,d){var f=new v,c=parseInt(this.LA-this.FOV/2,10);0>c&&(c+=360);var e=parseInt(this.LA+this.FOV/2,10);360<e&&(e-=360);360===this.FOV?(c=0,e=360,this._createWedgesUsingBuffers(f,a,b,d)):this._createWedgesUsingAngles(f,a[0],c,e,b,d);return f.promise},_getFeatureCollectionLayer:function(a){l.forEach(a,c.hitch(this,function(a,d){a.attributes={};a.attributes.ObjectID=d}));return new P({featureSet:{features:a,geometryType:"esriGeometryPoint"},layerDefinition:{name:"InputLayer",
geometryType:"esriGeometryPoint",objectIdField:"ObjectID",fields:[{name:"ObjectID",alias:"ObjectID",type:"esriFieldTypeOID"}]}})},_initAnalysisProcess:function(a){this._createWedges(a.InputObserver.features,a.MinimumRadius,a.MaximumRadius).then(c.hitch(this,function(b){var d,f=[],e;b&&2===b.length&&(e=this.appConfig.geometryService,d=q.getProjectedGeometry(b[0],this.map.spatialReference,e).then(c.hitch(this,function(a){this._wedgeGeometry=a})),f.push(d),b=q.getProjectedGeometry(b[1],this.map.spatialReference,
e).then(c.hitch(this,function(a){this._fullWedgeGeometry=a})),f.push(b),F(f).then(c.hitch(this,function(){this._createViewShed(a)})))}))},_createViewShed:function(a){a={portalUrl:this.portalUrl,inputLayer:this._getFeatureCollectionLayer(a.InputObserver.features),maxDistanceUnits:"Meters",maximumDistance:a.MaximumRadius,observerHeightUnits:"Meters",observerHeight:a.ObserverHeight,showSelectAnalysisLayer:!1,targetHeightUnits:"Meters",map:this.map,showChooseExtent:!1,returnFeatureCollection:!0};a=new O(a);
a.startup();a.on("job-result",c.hitch(this,this._onViewShedCreated));a.on("job-status",c.hitch(this,function(a){"esriJobFailed"===a.jobStatus&&this._showJobError(a)}));a.on("job-fail",c.hitch(this,this._showJobError));a._form.validate()?(this.busyIndicator.show(),a._handleSaveBtnClick()):new w({message:this.nls.validationError})},_showJobError:function(a){new w({message:a.message});this.busyIndicator.hide()},_onViewShedCreated:function(a){var b=[];l.forEach(a.value.featureSet.features,c.hitch(this,
function(a){a=new x(a.geometry);a.setSpatialReference(this.map.spatialReference);(a=p.difference(this._wedgeGeometry,a))&&(a=p.difference(this._wedgeGeometry,a));a=new n(a,this.visibleArea);b.push(a)}));this._showGraphicsOnMap(b)},_drawWedge:function(a,b){for(var d=new v,c=0,e=a.length;c<e;c++){var g=a[c];g&&g.geometry&&(g.setSymbol(b),this.graphicsLayer.add(g))}d.resolve("success");return d.promise},_drawViewshed:function(a){var b=new v;this.graphicsLayer.add(new n(this._wedgeGeometry,this.notVisibleArea));
for(var c=0,e=a.length;c<e;c++){var g=a[c];g&&g.geometry&&(g.setSymbol(this.visibleArea),this.graphicsLayer.add(g))}b.resolve("success");return b.promise},_showGraphicsOnMap:function(a){this._drawWedge([new n(this._fullWedgeGeometry)],this.fullWedge);this._drawWedge([new n(this._wedgeGeometry)],this.wedge);this._drawViewshed(a).then(c.hitch(this,function(){this.map.setExtent(A.graphicsExtent(this.graphicsLayer.graphics),!0);this.busyIndicator.hide()}))},createButtonWasClicked:function(){if(this.minObsRange.isValid()&&
this.maxObsRange.isValid()&&this.observerHeight.isValid()&&0!==parseInt(this.FOVInput.value,10)){var a=new n(this.inputControl.getMapCoordinateDD()),b=new L;b.features=[a];a={InputObserver:b,MinimumRadius:this.utils.convertToMeters(this.minObsRange.value,this.distanceUnit),MaximumRadius:this.utils.convertToMeters(this.maxObsRange.value,this.distanceUnit),ObserverHeight:this.utils.convertToMeters(this.observerHeight.value,this.observerHeightUnit)};this._initAnalysisProcess(a)}else new w({message:this.nls.validationError})},
onClearBtnClicked:function(){this.angleUnits&&(this.angleUnits.setValue(this.config.defaultAngleUnits),this.observerHeightDD.set("value",this.config.defaultObserverHeightUnit),this.distanceUnitDD.set("value",this.config.defaultObservableDistanceUnit),this.graphicsLayer.clear(),this.inputControl.clear(),this.FOVInput.disabled=!0,this.angleUnitsDidChange(),$("#"+this.FOVInput.id).trigger("configure",{fgColor:"#ccc",bgColor:"#ccc",inputColor:"#ccc"}),this.tooltip.hidden=!0,this.resetInputColor())},resetInputColor:function(){setTimeout(c.hitch(this,
function(){m.set(this.FOVInput,"color","gray")}),100)}})});