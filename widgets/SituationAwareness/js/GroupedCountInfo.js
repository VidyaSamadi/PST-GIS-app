// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt and http://www.arcgis.com/apps/webappbuilder/copyright.txt for details.
//>>built
define("dojo/_base/declare dojo/Evented dojo/_base/array dojo/DeferredList dojo/Deferred dojo/_base/lang dojo/dom-class dojo/dom-construct dojo/on jimu/utils jimu/dijit/Message esri/graphic esri/layers/FeatureLayer esri/tasks/query ./analysisUtils".split(" "),function(B,C,y,x,u,n,q,r,v,w,z,D,t,A,p){return B("GroupedCountInfo",[C],{summaryLayer:null,summaryFields:[],summaryIds:[],summaryFeatures:[],tabNum:null,popupFields:[],groupedResults:{},specialFields:null,dateFields:{},symbolField:null,graphicsLayer:null,
lyrRenderer:null,lyrSymbol:null,featureCount:0,incidentCount:0,displayCount:!1,allFields:!1,constructor:function(a,c,e){this.tab=a;this.container=c;this.parent=e;this.config=e.config;this.graphicsLayer=null;this.specialFields={};this.typeIdField="";this.types=[];this.dateFields={};this.baseLabel=""!==a.label?a.label:a.layerTitle?a.layerTitle:a.layers},queryTabCount:function(a,c,e,f){var g=new u;this.displayCount=f;this.incidentCount=a.length;var d=[this.tab.tabLayers[0]];this.mapServiceLayer&&1<this.tab.tabLayers.length&&
(d=[this.tab.tabLayers[1]]);if(0<this.tab.tabLayers.length&&this.tab.tabLayers[0].url&&-1<this.tab.tabLayers[0].url.indexOf("MapServer")){this.mapServiceLayer=!0;var b;"undefined"!==typeof this.tab.tabLayers[0].infoTemplate?(this.summaryLayer=this.tab.tabLayers[0],this.summaryLayer.hasOwnProperty("loaded")&&this.summaryLayer.loaded?(this.summaryFields=this._getFields(this.summaryLayer),this._performQuery(a,c,e,f,d).then(function(a){g.resolve(a)})):(b=new t(this.summaryLayer.url),b.infoTemplate=this.tab.tabLayers[0].infoTemplate,
d=[b],this.tab.tabLayers=d,v(b,"load",n.hitch(this,function(){this.summaryLayer=b;this.summaryFields=this._getFields(this.summaryLayer);this._performQuery(a,c,e,f,d).then(function(a){g.resolve(a)})})))):this.loading||(b=new t(this.tab.tabLayers[0].url),this.loading=!0,v(b,"load",n.hitch(this,function(){this.summaryLayer=b;this.summaryFields=this._getFields(this.summaryLayer);for(var k=this.tab.tabLayers[0].url.split("MapServer/")[1],h=this.parent.map.itemInfo.itemData.operationalLayers,m=0;m<h.length;m++){var l=
h[m];if(-1<this.tab.tabLayers[0].url.indexOf(l.url)&&"undefined"!==typeof l.layerObject)if(l.layerObject.infoTemplates){if(l=l.layerObject.infoTemplates[k]){b.infoTemplate=l.infoTemplate;break}}else if(l.layerObject.infoTemplate){b.infoTemplate=l.layerObject.infoTemplate;break}}d=[b];this.tab.tabLayers=d;this.loading=!1;this._performQuery(a,c,e,f,d).then(function(a){g.resolve(a)})})))}this.mapServiceLayer||this._performQuery(a,c,e,f,d).then(function(a){g.resolve(a)});return g},_performQuery:function(a,
c,e,f,g){var d=new u,b=[],k,h;0<c.length?h=p.getGeoms(c):0<a.length&&(h=p.getGeoms(a));this.summaryGeoms=h;if(0<h.length)for(a=0;a<h.length;a++)b=h[a],c=p.createDefArray(g,b,this.parent.opLayers,this.tab),k=0===a?b=c:b=k.concat(c);(new x(b)).then(n.hitch(this,function(a){for(var c=0,b=0;b<a.length;b++){var h=a[b][1];isNaN(h)?h&&h.features?c+=h.features.length:h&&"undefined"!==typeof h.length&&(c+=h.length):c+=h}this.updateTabCount(c,e,f);this.queryOnLoad&&n.hitch(this,this._queryFeatures(this.summaryGeoms));
d.resolve(c)}));return d},updateTabCount:function(a,c,e){this.displayCount=e;this.featureCount=a;p.updateTabCount(this.featureCount,c,e,this.baseLabel,this.incidentCount)},updateForIncident:function(a,c,e,f,g,d,b){this.incidentCount=a.length;this.allFields="undefined"!==typeof d&&"undefined"!==typeof b?d?!0:b:!1;var k="undefined"!==typeof g,h;this.tabNum=f;k?h=new u:(this.container.innerHTML="",q.add(this.container,"loading"));this.summaryIds=[];this.summaryFeatures=[];this.groupedResults={};if(0<
this.tab.tabLayers.length){var m=[];if(0<c.length)m=c;else for(c=0;c<a.length;c++)f=a[c].geometry?a[c].geometry:a[c],"polygon"===f.type&&m.push(f);var l;"undefined"!==typeof this.tab.tabLayers[0].infoTemplate?(this.summaryLayer=this.tab.tabLayers[0],l=new t(this.summaryLayer.url),l.infoTemplate=this.tab.tabLayers[0].infoTemplate,this.tab.tabLayers[1]=l,this.summaryFields=this._getFields(this.tab.tabLayers[0]),k?this._queryFeatures(m,k).then(function(a){h.resolve(a)}):(this._initGraphicsLayer(e),n.hitch(this,
this._queryFeatures(m)))):(l=new t(this.tab.tabLayers[0].url),v(l,"load",n.hitch(this,function(){this.summaryLayer=l;if(-1<this.tab.tabLayers[0].url.indexOf("MapServer"))for(var a=this.tab.tabLayers[0].url.split("MapServer/")[1],c=this.parent.map.itemInfo.itemData.operationalLayers,b=0;b<c.length;b++){var d=c[b];if(-1<this.tab.tabLayers[0].url.indexOf(d.url)&&"undefined"!==typeof d.layerObject&&d.layerObject.infoTemplates&&(d=d.layerObject.infoTemplates[a])){l.infoTemplate=d.infoTemplate;break}}this.tab.tabLayers[1]=
l;this.summaryLayer=this.tab.tabLayers[1];this.summaryFields=this._getFields(this.tab.tabLayers[1]);k?this._queryFeatures(m,k).then(function(a){h.resolve(a)}):(this._initGraphicsLayer(e),n.hitch(this,this._queryFeatures(m)))})));if(k)return h}},_initGraphicsLayer:function(a){null!==a&&(this.graphicsLayer=a,this.graphicsLayer.clear(),this.summaryLayer&&this.summaryLayer.renderer&&(this.lyrRenderer=this.summaryLayer.renderer,this.graphicsLayer.renderer=this.lyrRenderer,"undefined"!==typeof this.summaryLayer.renderer.attributeField?
this.symbolField=this.summaryLayer.renderer.attributeField:this.lyrSymbol=this.lyrRenderer.symbol))},_queryFeatures:function(a,c){var e;c&&(e=new u);for(var f=[],g=-1===[null,void 0,""].indexOf(this.tab.tabLayers[0].id)?this.tab.tabLayers[0].id:this.tab.layers,g=p.getFilter(g,this.parent.opLayers),d=new A,b=0;b<a.length;b++)d.geometry=a[b],d.where=g,f.push(this.summaryLayer.queryIds(d));(new x(f)).then(n.hitch(this,function(a){for(var b,d,f=0;f<a.length;f++)a[f][0]&&(b=a[f][1],d=b=0===f?b:d.concat(b));
b?(this.summaryIds=b,0<this.summaryIds.length?c?this._queryFeaturesByIds(c).then(function(a){e.resolve(a)}):this._queryFeaturesByIds():c||this._processResults()):c||this._processResults()}),n.hitch(this,function(a){console.error(a);new z({message:a})}));if(c)return e},_queryFeaturesByIds:function(a){var c,e=[];a&&(c=new u);var f=this.summaryLayer.maxRecordCount||1E3,g=this.summaryIds.slice(0,f);this.summaryIds.splice(0,f);var d=new A,b=-1===[null,void 0,""].indexOf(this.summaryLayer.id)?this.summaryLayer.id:
this.tab.layers;d.where=p.getFilter(b,this.parent.opLayers);var k=!1;y.some(this.summaryFields,n.hitch(this,function(a){if("area"===a.type||"length"===a.type||this.graphicsLayer)return k=!0}));a&&(k=!0);this.summaryLayer.supportsAdvancedQueries&&(d.orderByFields=[this.summaryFields[0].field]);d.returnGeometry=k;d.outSpatialReference=this.parent.map.spatialReference;d.outFields=["*"];d.objectIds=g;for(e.push(this.summaryLayer.queryFeatures(d));0<this.summaryIds.length;)g=this.summaryIds.slice(0,f),
this.summaryIds.splice(0,f),d.objectIds=g,e.push(this.summaryLayer.queryFeatures(d));(new x(e)).then(n.hitch(this,function(b){this.summaryFeatures=[];for(var d=0;d<b.length;d++)if(b[d][0]){var e=b[d][1];e.features&&(this.summaryFeatures=this.summaryFeatures.concat(e.features))}a?this._processResults(a).then(n.hitch(this,function(a){this.SA_SAT_download&&q.replace(this.SA_SAT_download,"download","processing");c.resolve(a)})):(this._processResults(),this.SA_SAT_download&&q.replace(this.SA_SAT_download,
"download","processing"));this.SA_SAT_download&&q.replace(this.SA_SAT_download,"download","processing")}),n.hitch(this,function(a){console.error(a);new z({message:a})}));if(a)return c},_prepGroupedResults:function(){for(var a=0;a<this.summaryFeatures.length;a++){var c=this.summaryFeatures[a];if("undefined"!==typeof this.summaryFields&&0<this.summaryFields.length){var e=p.getFieldValue(this.summaryFields[0].field,c.attributes[this.summaryFields[0].field],this.specialFields,this.dateFields,"longMonthDayYear",
this.typeIdField,this.types,this.layerObject&&this.layerObject.renderer?this.layerObject:this.layerDefinition,c.attributes),e="undefined"!==typeof e&&null!==e?w.stripHTML(e.toString()):"";e in this.groupedResults?this.groupedResults[e].features.push(c):this.groupedResults[e]={features:[c]}}}},_prepResults:function(){for(var a in this.groupedResults){var c=this.summaryFields[0];c.total=this.groupedResults[a].features.length;this.groupedResults[a].total=c.total;this.groupedResults[a].type=c.type;this.groupedResults[a].label=
c.alias}},_processResults:function(a){this._prepGroupedResults();this._prepResults();var c=this.groupedResults,e=0,f,g;if(a)g=new u;else{this.container.innerHTML="";q.remove(this.container,"loading");if(0===Object.keys(this.groupedResults).length){this.container.innerHTML=this.parent.nls.noFeaturesFound;return}var d=Object.keys(this.groupedResults).length+1;f=r.create("div",{style:"width:"+220*d+"px;"},this.container);q.add(f,"SAT_tabPanelContent");d=r.create("div",{},f);q.add(d,"SATcolExport");q.add(d,
this.parent.lightTheme?"lightThemeBorder":"darkThemeBorder");d=r.create("div",{"data-dojo-attach-point":"SA_SAT_download",title:this.parent.nls.downloadCSV},d);q.add(d,[this.parent.isBlackTheme?"btnExportBlack":"btnExport","download"]);v(d,"click",n.hitch(this,this._exportToCSV,c))}var b=Object.keys(c).sort(),d=[];this.displayCount&&d.push({total:this.featureCount,a:void 0,info:this.parent.nls.count,c:void 0});for(var k in b){var e=b[k],h=c[e],m=w.stripHTML(e.toString()),e=h.total;isNaN(e)&&(e=0);
var e=w.localizeNumber(e),l="pre"===h.type?h.label.trim():m,m="pre"===h.type?m:h.label.trim(),h=""!==h.label?"colGroupedSummary":"colSummary";if(a)d.push({total:e,a:l,info:""===m?l:m,c:h});else{var p=r.create("div",{"class":"SATcol"},f);q.add(p,this.parent.lightTheme?"lightThemeBorder":"darkThemeBorder");var t=r.create("div",{style:"max-height: 45px;"},p);r.create("div",{"class":"SATcolWrap",style:"max-height: 30px; overflow: hidden;",innerHTML:l},t);r.create("div",{"class":"SATcolWrap",style:"max-height: 30px; overflow: hidden;",
innerHTML:m},t);r.create("div",{"class":h,innerHTML:e},p)}}c=[];k=null!==this.graphicsLayer;!a&&k&&(this.graphicsLayer.clear(),this.tab.tabLayers[1]&&this.tab.tabLayers[1].clear());if(this.summaryFeatures)for(f=0;f<this.summaryFeatures.length;f++)b=this.summaryFeatures[f],this.lyrSymbol?b.symbol=this.lyrSymbol:this.graphicsLayer?this.graphicsLayer.renderer&&(e=this.graphicsLayer.renderer.getSymbol(b),b.symbol=e):this.summaryLayer.renderer&&this.summaryLayer.renderer.getSymbol&&(b.symbol=this.summaryLayer.renderer.getSymbol(b)),
b=b.toJson?new D(b.toJson()):b,!a&&k?(this.graphicsLayer.add(b),this.tab.tabLayers[1].add(b)):c.push(b);!a&&k&&(this.graphicsLayer.setVisibility(!0),this.parent._toggleTabLayersNew(this.tabNum),this.tab.retsore&&this.emit("summary-complete",{bubbles:!0,cancelable:!0,tab:this.tabNum}));if(a)return g.resolve({graphics:c,analysisResults:d,context:this}),g},_exportToCSV:function(a,c,e,f){a=p.exportToCSV(this.summaryFeatures,c,e,f,{type:"grouped",baseLabel:this.baseLabel,csvAllFields:this.parent.config.csvAllFields,
layer:this.summaryLayer,opLayers:this.parent.opLayers,nlsValue:this.parent.nls.groupedSummary,nlsCount:this.parent.nls.count,summaryFields:this.summaryFields});this.summaryLayer=a.summaryLayer;return a.details},_getFields:function(a){this.layerDefinition=w.getFeatureLayerDefinition(a);this.layerObject=a;var c=p.getSkipFields(a),e,f=[];if("undefined"!==typeof this.tab.advStat){var g=this.tab.advStat.stats,d;for(d in g)0<g[d].length&&y.forEach(g[d],function(a){var b={field:a.expression,alias:a.label+
"",type:d,total:0};e=a.expression;f.push(b)})}g=p.getSpecialFields(a);this.dateFields=g.dateFields;this.specialFields=g.specialFields;this.typeIdField=g.typeIdField;this.types=g.types;if(this.allFields)for(g=0;g<a.fields.length;g++){var b=a.fields[g];-1===c.indexOf(b.name)&&e!==b.name&&f.push({field:b.name,alias:b.alias,type:b.type})}return f}})});