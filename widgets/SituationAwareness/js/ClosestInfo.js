// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt and http://www.arcgis.com/apps/webappbuilder/copyright.txt for details.
//>>built
define("dojo/_base/declare dojo/_base/lang dojo/_base/Color dojo/_base/array dojo/DeferredList dojo/Deferred dojo/dom-class dojo/dom-construct dojo/dom-geometry dojo/dom-style dojo/on jimu/utils esri/geometry/geometryEngine esri/graphic esri/Color esri/layers/FeatureLayer esri/symbols/SimpleMarkerSymbol esri/symbols/SimpleLineSymbol esri/symbols/Font esri/symbols/TextSymbol esri/tasks/query ./analysisUtils".split(" "),function(O,p,I,P,J,F,q,w,Q,K,E,L,x,H,R,y,M,N,S,T,U,u){return O("ClosestInfo",null,
{featureCount:0,mapServiceLayer:!1,loading:!1,queryOnLoad:!1,incidentCount:0,constructor:function(a,b,g){this.tab=a;this.container=b;this.parent=g;this.graphicsLayer=this.incident=null;this.map=g.map;this.specialFields={};this.typeIdField="";this.types=[];this.dateFields={};this.config=g.config;this.baseLabel=""!==a.label?a.label:a.layerTitle?a.layerTitle:a.layers},queryTabCount:function(a,b,g,f){var l=new F;this.incidentCount=a.length;var e=this.parent.config.distanceSettings[this.parent.config.distanceUnits],
m=this.parent.config.maxDistance;b=[];for(var h=0;h<a.length;h++){var c=a[h].geometry;"4326"===c.spatialReference.wkid||c.spatialReference.isWebMercator()?b.push(x.geodesicBuffer(c,m,e)):b.push(x.buffer(c,m,e))}var k=[this.tab.tabLayers[0]];this.mapServiceLayer&&1<this.tab.tabLayers.length&&(k=[this.tab.tabLayers[1]]);if(0<this.tab.tabLayers.length&&this.tab.tabLayers[0].url&&-1<this.tab.tabLayers[0].url.indexOf("MapServer")){this.mapServiceLayer=!0;var d;"undefined"!==typeof this.tab.tabLayers[0].infoTemplate?
(this.summaryLayer=this.tab.tabLayers[0],this.summaryLayer.hasOwnProperty("loaded")&&this.summaryLayer.loaded?(this.summaryFields=this._getFields(this.summaryLayer),this._performQuery(a,b,g,f,k).then(function(a){l.resolve(a)})):(d=new y(this.summaryLayer.url),d.infoTemplate=this.tab.tabLayers[0].infoTemplate,k=[d],this.tab.tabLayers=k,E(d,"load",p.hitch(this,function(){this.summaryLayer=d;this.summaryFields=this._getFields(this.summaryLayer);this._performQuery(a,b,g,f,k).then(function(a){l.resolve(a)})})))):
this.loading||(d=new y(this.tab.tabLayers[0].url),this.loading=!0,E(d,"load",p.hitch(this,function(){this.summaryLayer=d;this.summaryFields=this._getFields(this.summaryLayer);for(var c=this.tab.tabLayers[0].url.split("MapServer/")[1],z=this.parent.map.itemInfo.itemData.operationalLayers,e=0;e<z.length;e++){var h=z[e];if(-1<this.tab.tabLayers[0].url.indexOf(h.url)&&"undefined"!==typeof h.layerObject&&h.layerObject.infoTemplates&&(h=h.layerObject.infoTemplates[c])){d.infoTemplate=h.infoTemplate;break}}k=
[d];this.tab.tabLayers=k;this.loading=!1;this._performQuery(a,b,g,f,k).then(function(a){l.resolve(a)})})))}this.mapServiceLayer||this._performQuery(a,b,g,f,k).then(function(a){l.resolve(a)});return l},_performQuery:function(a,b,g,f,l){var e=new F,m=[],h,c;this.summaryGeoms=b;if(0<b.length)for(a=0;a<b.length;a++)m=b[a],c=u.createDefArray(l,m,this.parent.opLayers,this.tab),h=0===a?m=c:m=h.concat(c);(new J(m)).then(p.hitch(this,function(a){for(var d=0,b=0;b<a.length;b++){var c=a[b][1];isNaN(c)?c&&c.features?
0<c.features.length&&(d+=1):c&&"undefined"!==typeof c.length&&0<c.length&&(d+=1):0<c&&(d+=1)}this.updateTabCount(d,g,f);e.resolve(d)}));return e},updateTabCount:function(a,b,g){this.featureCount=0===parseInt(a,10)?0:a;u.updateTabCount(this.featureCount,b,g,this.baseLabel,this.incidentCount)},updateForIncident:function(a,b,g,f,l,e){this.incidentCount=a.length;this.allFields="undefined"!==typeof l&&"undefined"!==typeof e?l?!0:e:!1;var m="undefined"!==typeof f,h;P.forEach(this.tab.tabLayers,p.hitch(this,
function(c){m&&(h=new F);if(c.url){var e=new y(c.url,{mode:y.MODE_ONDEMAND,infoTemplate:c.infoTemplate});E(e,"load",p.hitch(this,function(){this.tab.tabLayers=[e];m?this.processIncident(a,b,g,f).then(p.hitch(this,function(a){h.resolve(a)}),p.hitch(this,function(a){console.error(a);h.reject(a)})):this.processIncident(a,b,g,f)}))}else m?this.processIncident(a,b,g,f).then(p.hitch(this,function(a){h.resolve(a)}),p.hitch(this,function(a){console.error(a);h.reject(a)})):this.processIncident(a,b,g,f)}));
if(m)return h},processIncident:function(a,b,g,f){this.incidents=a;var l,e="undefined"!==typeof f;e?l=new F:(this.container.innerHTML="",q.add(this.container,"loading"));var m=[];f=this.parent.config.distanceSettings[this.parent.config.distanceUnits];for(var h=[],c=0;c<a.length;c++){var k=a[c].geometry,d;d="4326"===k.spatialReference.wkid||k.spatialReference.isWebMercator()?x.geodesicBuffer(k,b,f):x.buffer(k,b,f);h.push({geometry:k,buffer:d})}(this.graphicsLayer=g)&&this.graphicsLayer.clear();a=[];
b=this.tab.tabLayers[0];g=-1===[null,void 0,""].indexOf(b.id)?b.id:this.tab.layers;g=u.getFilter(g,this.parent.opLayers);var r=this._getFields(b);for(f=0;f<h.length;f++)c=new U,c.returnGeometry=!0,c.outSpatialReference=this.parent.map.spatialReference,c.geometry=h[f].buffer,c.where=g,c.outFields=["*"],"undefined"!==typeof b.queryFeatures&&a.push(b.queryFeatures(c));(new J(a)).then(p.hitch(this,function(a){for(var b=0;b<a.length;b++)if(a[b][0]){var c=a[b][1].features,d=[],g=h[b].geometry;if(c&&0<c.length){for(var f=
0;f<c.length;f++){for(var k=new H(c[f].toJson()),q=u.getDistance(g,k.geometry,this.parent.config.distanceUnits),n={DISTANCE:q},t=0;t<r.length;t++)n[r[t]]=k.attributes[r[t]];!0===this.config.csvAllFields||"true"===this.config.csvAllFields?k.attributes.DISTANCE=q:k.attributes=n;d.push(k)}d.sort(u.compareDistance);m.push(d[0])}}else a[b][1]&&a[b][1].message&&console.log(a[b][1].message);m.sort(u.compareDistance);e?this._processResults(m,!0).then(p.hitch(this,function(a){l.resolve(a)})):this._processResults(m)}),
p.hitch(this,function(a){console.error(a);l.reject(a)}));if(e)return l},_processResults:function(a,b){var g,f,l=a&&0<a.length;if(l&&"point"!==a[0].geometry.type)for(var e=a.length-1;0<=e;e--)"undefined"===typeof a[e].geometry.getExtent()&&a.splice(e,1);b?g=new F:(this.container.innerHTML="",q.remove(this.container,"loading"),l&&(f=w.create("div",{"class":"SAT_tabPanelContent"},this.container),e=w.create("div",{},f),q.add(e,"SATcolExport"),q.add(e,this.parent.lightTheme?"lightThemeBorder":"darkThemeBorder"),
e=w.create("div",{title:this.parent.nls.downloadCSV},e),q.add(e,"btnExport"),E(e,"click",p.hitch(this,this._exportToCSV,a))));var e=this.parent.nls[this.parent.config.distanceUnits],m=[],h=220;if(l)for(var c=0;c<a.length;c++){var k=c+1,d=a[c],r=d.geometry,z=r;"point"!==r.type&&(z=r.getExtent().getCenter());var r=d.attributes,x;"point"===this.incidents[0].geometry.type&&(x=Math.round(100*r.DISTANCE)/100+" "+e+" ("+this.parent.nls.approximate+")");var A="",v=0,B=[];if("undefined"!==typeof this.displayFields)for(var y=
0;y<this.displayFields.length;y++){var C=this.displayFields[y],D;a:for(D in r)if("DISTANCE"!==D&&3>v&&C.expression===D){var n=u.getFieldValue(D,r[D],this.specialFields,this.dateFields,"longMonthDayYear",this.typeIdField,this.types,this.layerObject&&this.layerObject.renderer?this.layerObject:this.layerDefinition,r,C),n="undefined"!==typeof n&&null!==n?L.stripHTML(n.toString()):"",t="undefined"!==typeof C.label&&""!==C.label?C.label:void 0,G=d._layer&&d._layer.fields?d._layer.fields:this.tab.tabLayers&&
this.tab.tabLayers[0]?this.tab.tabLayers[0].fields:void 0;G&&"undefined"===typeof t&&(G=u.getField(G,D))&&(t=G.alias);if("undefined"===typeof t||t in[""," ",null,void 0])t=D;u.isURL(n)?n='\x3ca href\x3d"'+n+'" target\x3d"_blank" style\x3d"color: inherit;"\x3e'+t+"\x3c/a\x3e":u.isEmail(n)&&(n='\x3ca href\x3d"mailto:'+n+'" style\x3d"color: inherit;"\x3e'+t+"\x3c/a\x3e");A+=C.validLabel?("undefined"!==typeof C.label&&""!==C.label?t+" ":"")+n+"\x3cbr/\x3e":n+"\x3cbr/\x3e";v+=1;B.push({value:-1<n.indexOf(",")?
n.replace(",",""):n,label:t});break a}}m.push(B);b||(d=w.create("div",{},f),q.add(d,"SATcolRec"),q.add(d,this.parent.lightTheme?"lightThemeBorder":"darkThemeBorder"),v=w.create("div",{},d),q.add(v,"SATcolRecBar"),B=w.create("div",{innerHTML:k},v),q.add(B,"SATcolRecNum"),K.set(B,"backgroundColor",this.parent.config.activeColor),E(B,"click",p.hitch(this,this._zoomToLocation,z)),x&&(B=w.create("div",{innerHTML:x},v),q.add(B,"SATcolDistance")),this.parent.config.enableRouting&&(v=w.create("div",{title:this.parent.nls.get_directions},
v),q.add(v,"SATcolDir"),E(v,"click",p.hitch(this,this._routeToIncident,z))),A=w.create("div",{"class":"SATcolWrap",innerHTML:A},d),q.add(A,"SATcolInfo"),h+=Q.position(d).w,A=new N(N.STYLE_SOLID,new I.fromRgb(this.parent.config.activeMapGraphicColor),1),A=new M(M.STYLE_CIRCLE,24,A,new I.fromRgb(this.parent.config.activeMapGraphicColor)),d=new S,d.family="Arial",d.size="12px",k=new T(k,d,new R(this.parent.config.fontColor)),k.setOffset(0,-4),this.graphicsLayer.add(new H(z,A,r)),this.graphicsLayer.add(new H(z,
k,r)))}if(!b&&l)K.set(f,"width",h);else if(l)return g.resolve({graphics:a,analysisResults:m,context:this}),g},_exportToCSV:function(a,b,g,f){a=u.exportToCSV(a,b,g,f,{type:"closest",baseLabel:this.baseLabel,csvAllFields:this.parent.config.csvAllFields,layer:this.tab.tabLayers[0],opLayers:this.parent.opLayers,nlsValue:this.parent.nls.closest,nlsCount:this.parent.nls.count});this.summaryLayer=a.summaryLayer;return a.details},_getFields:function(a){this.layerDefinition=L.getFeatureLayerDefinition(a);
this.layerObject=a;a=u.getFields(a,this.tab,this.allFields,this.parent);this.dateFields=a.dateFields;this.specialFields=a.specialFields;this.typeIdField=a.typeIdField;this.types=a.types;this.displayFields=u.getDisplayFields(this.tab);return a.fields},_zoomToLocation:function(a){this.parent.zoomToLocation(a)},_routeToIncident:function(a){this.parent.routeToIncident(a)}})});