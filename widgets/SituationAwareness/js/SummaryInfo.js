// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt and http://www.arcgis.com/apps/webappbuilder/copyright.txt for details.
//>>built
define("dojo/_base/declare dojo/Evented dojo/_base/array dojo/DeferredList dojo/Deferred dojo/_base/lang dojo/dom-class dojo/dom-construct dojo/on jimu/utils jimu/dijit/Message esri/graphic esri/layers/FeatureLayer esri/tasks/query esri/tasks/QueryTask ./analysisUtils".split(" "),function(B,C,w,x,t,m,q,r,u,y,z,D,v,A,E,n){return B("SummaryInfo",[C],{summaryLayer:null,summaryFields:[],summaryIds:[],summaryFeatures:[],tabNum:null,symbolField:null,graphicsLayer:null,lyrRenderer:null,lyrSymbol:null,featureCount:0,
mapServiceLayer:!1,loading:!1,queryOnLoad:!1,incidentCount:0,allFields:!1,constructor:function(a,d,f){this.tab=a;this.container=d;this.parent=f;this.config=f.config;this.graphicsLayer=null;this.baseLabel=""!==a.label?a.label:a.layerTitle?a.layerTitle:a.layers},queryTabCount:function(a,d,f,c){var k=new t;this.incidentCount=a.length;var b=[this.tab.tabLayers[0]];this.mapServiceLayer&&1<this.tab.tabLayers.length&&(b=[this.tab.tabLayers[1]]);if(0<this.tab.tabLayers.length&&this.tab.tabLayers[0].url&&
-1<this.tab.tabLayers[0].url.indexOf("MapServer")){this.mapServiceLayer=!0;var h;"undefined"!==typeof this.tab.tabLayers[0].infoTemplate?(this.summaryLayer=this.tab.tabLayers[0],this.summaryLayer.hasOwnProperty("loaded")&&this.summaryLayer.loaded?(this.summaryFields=this._getFields(this.summaryLayer),this._performQuery(a,d,f,c,b).then(function(a){k.resolve(a)})):(h=new v(this.summaryLayer.url),h.infoTemplate=this.tab.tabLayers[0].infoTemplate,b=[h],this.tab.tabLayers=b,u(h,"load",m.hitch(this,function(){this.summaryLayer=
h;this.summaryFields=this._getFields(this.summaryLayer);this._performQuery(a,d,f,c,b).then(function(a){k.resolve(a)})})))):this.loading||(h=new v(this.tab.tabLayers[0].url),this.loading=!0,u(h,"load",m.hitch(this,function(){this.summaryLayer=h;this.summaryFields=this._getFields(this.summaryLayer);for(var g=this.tab.tabLayers[0].url.split("MapServer/")[1],e=this.parent.map.itemInfo.itemData.operationalLayers,p=0;p<e.length;p++){var l=e[p];if(-1<this.tab.tabLayers[0].url.indexOf(l.url)&&"undefined"!==
typeof l.layerObject)if(l.layerObject.infoTemplates){if(l=l.layerObject.infoTemplates[g]){h.infoTemplate=l.infoTemplate;break}}else if(l.layerObject.infoTemplate){h.infoTemplate=l.layerObject.infoTemplate;break}}b=[h];this.tab.tabLayers=b;this.loading=!1;this._performQuery(a,d,f,c,b).then(function(a){k.resolve(a)})})))}this.mapServiceLayer||this._performQuery(a,d,f,c,b).then(function(a){k.resolve(a)});return k},_performQuery:function(a,d,f,c,k){var b=new t,h=[],g,e;0<d.length?e=n.getGeoms(d):0<a.length&&
(e=n.getGeoms(a));this.summaryGeoms=e;if(0<e.length)for(a=0;a<e.length;a++)h=e[a],d=n.createDefArray(k,h,this.parent.opLayers,this.tab),g=0===a?h=d:h=g.concat(d);(new x(h)).then(m.hitch(this,function(a){for(var e=0,g=0;g<a.length;g++){var d=a[g][1];isNaN(d)?d&&d.features?e+=d.features.length:d&&"undefined"!==typeof d.length&&(e+=d.length):e+=d}this.updateTabCount(e,f,c);this.queryOnLoad&&m.hitch(this,this._queryFeatures(this.summaryGeoms));b.resolve(e)}));return b},updateTabCount:function(a,d,f){this.featureCount=
a;n.updateTabCount(this.featureCount,d,f,this.baseLabel,this.incidentCount)},updateForIncident:function(a,d,f,c,k,b,h){this.incidentCount=a.length;this.allFields="undefined"!==typeof b&&"undefined"!==typeof h?b?!0:h:!1;var g="undefined"!==typeof k,e;this.tabNum=c;g?e=new t:(this.container.innerHTML="",q.add(this.container,"loading"));this.summaryIds=[];this.summaryFeatures=[];if(0<this.tab.tabLayers.length){var p=this.summaryGeoms,l;"undefined"!==typeof this.tab.tabLayers[0].infoTemplate?(this.summaryLayer=
this.tab.tabLayers[0],l=new v(this.summaryLayer.url),l.infoTemplate=this.tab.tabLayers[0].infoTemplate,this.tab.tabLayers[1]=l,this.summaryFields=this._getFields(this.tab.tabLayers[0]),g?this._queryFeatures(p,g).then(function(a){e.resolve(a)}):(this._initGraphicsLayer(f),m.hitch(this,this._queryFeatures(p)))):(l=new v(this.tab.tabLayers[0].url),u(l,"load",m.hitch(this,function(){this.summaryLayer=l;if(-1<this.tab.tabLayers[0].url.indexOf("MapServer"))for(var a=this.tab.tabLayers[0].url.split("MapServer/")[1],
d=this.parent.map.itemInfo.itemData.operationalLayers,c=0;c<d.length;c++){var b=d[c];if(-1<this.tab.tabLayers[0].url.indexOf(b.url)&&"undefined"!==typeof b.layerObject&&b.layerObject.infoTemplates&&(b=b.layerObject.infoTemplates[a])){l.infoTemplate=b.infoTemplate;break}}this.tab.tabLayers[1]=l;this.summaryLayer=this.tab.tabLayers[1];this.summaryFields=this._getFields(this.tab.tabLayers[1]);g?this._queryFeatures(p,g).then(function(a){e.resolve(a)}):(this._initGraphicsLayer(f),m.hitch(this,this._queryFeatures(p)))})));
if(g)return e}},_initGraphicsLayer:function(a){null!==a&&(this.graphicsLayer=a,this.graphicsLayer.clear(),this.summaryLayer&&this.summaryLayer.renderer&&(this.lyrRenderer=this.summaryLayer.renderer,this.graphicsLayer.renderer=this.lyrRenderer,"undefined"!==typeof this.summaryLayer.renderer.attributeField?this.symbolField=this.summaryLayer.renderer.attributeField:this.lyrSymbol=this.lyrRenderer.symbol))},_queryFeatures:function(a,d){var f;d&&(f=new t);for(var c=[],k=-1===[null,void 0,""].indexOf(this.tab.tabLayers[0].id)?
this.tab.tabLayers[0].id:this.tab.layers,k=n.getFilter(k,this.parent.opLayers),b=new A,h=0;h<a.length;h++)b.geometry=a[h],b.where=k,c.push(this.summaryLayer.queryIds(b));(new x(c)).then(m.hitch(this,function(a){for(var e,b,c=0;c<a.length;c++)a[c][0]&&(e=a[c][1],b=e=0===c?e:b.concat(e));e?(this.summaryIds=e,0<this.summaryIds.length?d?this._queryFeaturesByIds(d).then(function(a){f.resolve(a)}):this._queryFeaturesByIds():d||this._processResults()):d||this._processResults()}),m.hitch(this,function(a){console.error(a);
new z({message:a})}));if(d)return f},_queryFeaturesByIds:function(a){var d,f=[];a&&(d=new t);var c=this.summaryLayer.maxRecordCount||1E3,k=this.summaryIds.slice(0,c);this.summaryIds.splice(0,c);var b=new A;b.where=n.getFilter(this.summaryLayer.id,this.parent.opLayers);var h=!1;w.some(this.summaryFields,m.hitch(this,function(a){if("area"===a.type||"length"===a.type||this.graphicsLayer)return h=!0}));a&&(h=!0);b.returnGeometry=h;b.outSpatialReference=this.parent.map.spatialReference;b.outFields=["*"];
b.objectIds=k;var g=new E(this.summaryLayer.url);for(f.push(g.execute(b));0<this.summaryIds.length;)k=this.summaryIds.slice(0,c),this.summaryIds.splice(0,c),b.objectIds=k,f.push(g.execute(b));(new x(f)).then(m.hitch(this,function(c){this.summaryFeatures=[];for(var b=0;b<c.length;b++)if(c[b][0]){var e=c[b][1];e.features&&(this.summaryFeatures=this.summaryFeatures.concat(e.features))}a?this._processResults(a).then(m.hitch(this,function(a){this.SA_SAT_download&&q.replace(this.SA_SAT_download,"download",
"processing");d.resolve(a)})):(this._processResults(),this.SA_SAT_download&&q.replace(this.SA_SAT_download,"download","processing"));this.SA_SAT_download&&q.replace(this.SA_SAT_download,"download","processing")}),m.hitch(this,function(a){console.error(a);new z({message:a})}));if(a)return d},_prepResults:function(){for(var a=0;a<this.summaryFields.length;a++){var d=this.summaryFields[a],f=d.field,c=d.total;switch(d.type){case "count":c=this.summaryFeatures.length;break;case "area":c=n.getArea(this.summaryFeatures,
this.summaryGeoms,this.config.distanceSettings,this.config.distanceUnits,this.tab.advStat);break;case "length":c=n.getLength(this.summaryFeatures,this.summaryGeoms,this.config.distanceSettings,this.config.distanceUnits,this.tab.advStat);break;case "sum":c=n.getSum(this.summaryFeatures,f);break;case "avg":c=n.getSum(this.summaryFeatures,f)/this.summaryFeatures.length;break;case "min":c=n.getMin(this.summaryFeatures,f);break;case "max":c=n.getMax(this.summaryFeatures,f)}d.total=c}},_processResults:function(a){this._prepResults();
var d,f=this.summaryFields,c=0,k;if(a)d=new t;else{this.container.innerHTML="";q.remove(this.container,"loading");if(0===this.summaryFeatures.length){this.container.innerHTML=this.parent.nls.noFeaturesFound;return}k=r.create("div",{style:"width:"+220*(f.length+1)+"px;"},this.container);q.add(k,"SAT_tabPanelContent");var b=r.create("div",{},k);q.add(b,"SATcolExport");q.add(b,this.parent.lightTheme?"lightThemeBorder":"darkThemeBorder");b=r.create("div",{"data-dojo-attach-point":"SA_SAT_download",title:this.parent.nls.downloadCSV},
b);q.add(b,[this.parent.isBlackTheme?"btnExportBlack":"btnExport","download"]);u(b,"click",m.hitch(this,this._exportToCSV,f))}for(var b=[],h=0;h<f.length;h++){var g=f[h],e=y.stripHTML(g.alias?g.alias:"")+"\x3cbr/\x3e",g=n.formatNumber(g.total,g),c=g.total,g=g.num;if(a)b.push({num:g,info:e,total:c});else{c=r.create("div",{"class":"SATcol"},k);q.add(c,this.parent.lightTheme?"lightThemeBorder":"darkThemeBorder");var p=r.create("div",{style:"max-height: 60px;"},c);r.create("div",{"class":" SATcolWrap",
style:"max-height: 30px; overflow: hidden;",innerHTML:e},p);r.create("div",{"class":" colSummary",innerHTML:g},c)}}f=[];k=null!==this.graphicsLayer;!a&&k&&(this.graphicsLayer.clear(),this.tab.tabLayers[1].clear());if(this.summaryFeatures)for(h=0;h<this.summaryFeatures.length;h++)e=this.summaryFeatures[h],this.lyrSymbol?e.symbol=this.lyrSymbol:k&&this.graphicsLayer.renderer?(g=this.graphicsLayer.renderer.getSymbol(e),e.symbol=g):this.summaryLayer.renderer&&this.summaryLayer.renderer.getSymbol&&(e.symbol=
this.summaryLayer.renderer.getSymbol(e)),e=e.toJson?new D(e.toJson()):e,!a&&k?(this.graphicsLayer.add(e),this.tab.tabLayers[1].add(e)):f.push(e);!a&&k&&(this.graphicsLayer.setVisibility(!0),this.parent._toggleTabLayersNew(this.tabNum),this.tab.restore&&this.emit("summary-complete",{bubbles:!0,cancelable:!0,tab:this.tabNum}));if(a)return d.resolve({graphics:f,analysisResults:b,context:this}),d},_exportToCSV:function(a,d,f,c){a=n.exportToCSV(this.summaryFeatures,d,f,c,{type:"summary",baseLabel:this.baseLabel,
csvAllFields:this.parent.config.csvAllFields,layer:this.summaryLayer,opLayers:this.parent.opLayers,nlsValue:this.parent.nls.summary,nlsCount:this.parent.nls.count,summaryFields:this.summaryFields,calcFields:this.calcFields});this.summaryLayer=a.summaryLayer;return a.details},_getFieldInfoByFieldInfo:function(a,d,f){return this._getFieldInfo(a[d],d,f)},_getFieldInfoByName:function(a,d){var f=["count","area","length","tabCount"],c;for(c in a)if(-1===f.indexOf(c))return this._getFieldInfo(a[c],c,d)},
_getFieldInfo:function(a,d,f){for(var c=0;c<a.length;c++){var k=a[c];if(k.expression&&k.expression===f)return{field:{field:k.expression,alias:k.label,type:d,modify:k.modify,round:k.round,roundPlaces:k.roundPlaces,truncate:k.truncate,truncatePlaces:k.truncatePlaces,total:0},index:c}}},_getFields:function(a){this.layerDefinition=y.getFeatureLayerDefinition(a);this.layerObject=a;var d=n.getSkipFields(a),f=[];if("undefined"!==typeof this.tab.advStat){var c=m.clone(this.tab.advStat.stats);this.tab.advStat.fieldOrder&&
w.forEach(this.tab.advStat.fieldOrder,m.hitch(this,function(a){if((a=a&&a.hasOwnProperty("fieldName")?this._getFieldInfoByFieldInfo(c,a.fieldType,a.fieldName):this._getFieldInfoByName(c,a))&&a.field){var b=c[a.field.type];b.splice(a.index,1);0===b.length&&delete c[a.field.type];f.push(a.field)}}));for(var k in c)0<c[k].length&&w.forEach(c[k],function(a){f.push({field:a.expression,alias:a.label,type:k,modify:a.modify,round:a.round,roundPlaces:a.roundPlaces,truncate:a.truncate,truncatePlaces:a.truncatePlaces,
total:0})})}else{var b;if(a.infoTemplate)b=a.infoTemplate.info.fieldInfos;else if(-1<this.tab.tabLayers[0].url.indexOf("MapServer")){var h=this.tab.tabLayers[0].url.split("MapServer/")[1],g=this.parent.map.itemInfo.itemData.operationalLayers;b=null;for(var e=0;e<g.length;e++){var p=g[e];if(p.layerObject.infoTemplates&&(p=p.layerObject.infoTemplates[h])){b=p.infoTemplate.info.fieldInfos;break}}}else b=a.fields;b||(b=a.fields);for(h=0;h<b.length;h++)if(g=b[h],"undefined"!==typeof a.fields){var e=a.fields[h].type,
l;g.name===a.objectIdField||"esriFieldTypeDouble"!==e&&"esriFieldTypeInteger"!==e&&"esriFieldTypeSmallInteger"!==e||("undefined"!==typeof g.visible?g.visible&&(l={field:g.fieldName,alias:g.label,type:"sum",total:0}):l={field:g.name,alias:g.alias,type:"sum",total:0},l&&-1===d.indexOf(l.field)&&f.push(l),l=null)}}this.calcFields=m.clone(f);if(this.allFields)for(b=0;b<a.fields.length;b++){l=a.fields[b];h=!0;g=0;b:for(;g<f.length;g++)if(l.name===f[g].field){h=!1;break b}-1===d.indexOf(l.name)&&h&&f.push({field:l.name,
alias:l.alias,type:l.type})}a=n.getSpecialFields(a);this.dateFields=a.dateFields;this.specialFields=a.specialFields;this.typeIdField=a.typeIdField;this.types=a.types;return f}})});