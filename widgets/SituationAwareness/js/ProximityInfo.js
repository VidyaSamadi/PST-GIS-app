// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt and http://www.arcgis.com/apps/webappbuilder/copyright.txt for details.
//>>built
define("dojo/_base/declare dojo/_base/lang dojo/_base/Color dojo/_base/array dojo/DeferredList dojo/Deferred dojo/dom-class dojo/dom-construct dojo/dom-geometry dojo/dom-style dojo/on esri/graphic esri/Color esri/layers/FeatureLayer esri/symbols/SimpleMarkerSymbol esri/symbols/SimpleLineSymbol esri/symbols/Font esri/symbols/TextSymbol esri/tasks/query esri/geometry/geometryEngine jimu/utils ./analysisUtils".split(" "),function(Q,k,J,G,K,H,w,z,R,L,F,M,S,A,N,O,T,U,V,x,P,p){return Q("ProximityInfo",
null,{featureCount:0,mapServiceLayer:!1,loading:!1,queryOnLoad:!1,incidentCount:0,constructor:function(a,d,f){this.tab=a;this.container=d;this.parent=f;this.graphicsLayer=this.incident=null;this.specialFields={};this.typeIdField="";this.types=[];this.dateFields={};this.config=f.config;this.baseLabel=""!==a.label?a.label:a.layerTitle?a.layerTitle:a.layers},queryTabCount:function(a,d,f,h){var e=new H;this.incidentCount=a.length;var b=[this.tab.tabLayers[0]];this.mapServiceLayer&&1<this.tab.tabLayers.length&&
(b=[this.tab.tabLayers[1]]);if(0<this.tab.tabLayers.length&&this.tab.tabLayers[0].url&&-1<this.tab.tabLayers[0].url.indexOf("MapServer")){this.mapServiceLayer=!0;var c;"undefined"!==typeof this.tab.tabLayers[0].infoTemplate?(this.summaryLayer=this.tab.tabLayers[0],this.summaryLayer.hasOwnProperty("loaded")&&this.summaryLayer.loaded?(this.summaryFields=this._getFields(this.summaryLayer),this._performQuery(a,d,f,h,b).then(function(a){e.resolve(a)})):(c=new A(this.summaryLayer.url),c.infoTemplate=this.tab.tabLayers[0].infoTemplate,
b=[c],this.tab.tabLayers=b,F(c,"load",k.hitch(this,function(){this.summaryLayer=c;this.summaryFields=this._getFields(this.summaryLayer);this._performQuery(a,d,f,h,b).then(function(a){e.resolve(a)})})))):this.loading||(c=new A(this.tab.tabLayers[0].url),this.loading=!0,F(c,"load",k.hitch(this,function(){this.summaryLayer=c;this.summaryFields=this._getFields(this.summaryLayer);for(var b=this.tab.tabLayers[0].url.split("MapServer/")[1],k=this.parent.map.itemInfo.itemData.operationalLayers,v=0;v<k.length;v++){var q=
k[v];if(-1<this.tab.tabLayers[0].url.indexOf(q.url)&&"undefined"!==typeof q.layerObject&&q.layerObject.infoTemplates&&(q=q.layerObject.infoTemplates[b])){c.infoTemplate=q.infoTemplate;break}}this.tab.tabLayers=[c];this.loading=!1;this._performQuery(a,d,f,h,this.tab.tabLayers).then(function(a){e.resolve(a)})})))}this.mapServiceLayer||this._performQuery(a,d,f,h,b).then(function(a){e.resolve(a)});return e},_performQuery:function(a,d,f,h,e){var b=new H,c=[],g,t;0<d.length?t=p.getGeoms(d):0<a.length&&
(t=p.getGeoms(a));this.summaryGeoms=t;if(0<t.length)for(a=0;a<t.length;a++)c=t[a],d=p.createDefArray(e,c,this.parent.opLayers,this.tab),g=0===a?c=d:c=g.concat(d);(new K(c)).then(k.hitch(this,function(a){for(var c=0,e=0;e<a.length;e++){var d=a[e][1];isNaN(d)?d&&d.features?c+=d.features.length:d&&"undefined"!==typeof d.length&&(c+=d.length):c+=d}this.updateTabCount(c,f,h);b.resolve(c)}));return b},updateTabCount:function(a,d,f){this.featureCount=a;p.updateTabCount(this.featureCount,d,f,this.baseLabel,
this.incidentCount)},updateForIncident:function(a,d,f,h,e,b){this.incidentCount=a.length;this.allFields="undefined"!==typeof e&&"undefined"!==typeof b?e?!0:b:!1;var c="undefined"!==typeof h,g;G.forEach(this.tab.tabLayers,k.hitch(this,function(b){c&&(g=new H);if(b.url){var e=new A(b.url,{mode:A.MODE_ONDEMAND,infoTemplate:b.infoTemplate});F(e,"load",k.hitch(this,function(){this.tab.tabLayers=[e];c?this.processIncident(a,d,f,h).then(k.hitch(this,function(a){g.resolve(a)}),k.hitch(this,function(a){console.error(a);
g.reject(a)})):this.processIncident(a,d,f,h)}))}else c?this.processIncident(a,d,f,h).then(k.hitch(this,function(a){g.resolve(a)}),k.hitch(this,function(a){console.error(a);g.reject(a)})):this.processIncident(a,d,f,h)}));if(c)return g},processIncident:function(a,d,f,h){this.incidents=a;var e=[],b;if(0===d.length)for(var c=0;c<a.length;c++)b=a[c],b=b.geometry?b.geometry:b,"polygon"===b.type?(d.push(b),e.push({geometry:b,buffer:b})):e.push({geometry:void 0,buffer:void 0});else for(c=0;c<a.length;c++){b=
a[c];var g=d[c].geometry?d[c].geometry:d[c];b=b.geometry?b.geometry:b;e.push({geometry:b,buffer:g})}if(0!==d.length){for(a=0;a<e.length;a++)if(d=e[a].buffer,"undefined"!==typeof d)for(b=0;b<e.length;b++)if(b!==a&&(c=e[b].buffer,"undefined"!==typeof c&&x.overlaps(d,c))){e[a].buffer=x.difference(d,c);e[b].buffer=x.difference(c,d);c=x.union(c,d);c=x.difference(c,e[a].buffer);c=x.difference(c,e[b].buffer);if(Array.isArray(e[a].geometry)){if(Array.isArray(e[b].geometry))for(g=0;g<e[b].geometry.length;g++)e[a].geometry.push(e[b].geometry[g]);
else e[a].geometry.push(e[b].geometry);g=e[a].geometry}else if(g=[],g.push(e[a].geometry),Array.isArray(e[b].geometry))for(var t=0;t<e[b].geometry.length;t++)g.push(e[b].geometry[t]);else g.push(e[b].geometry);e.push({geometry:g,buffer:c})}var v,q="undefined"!==typeof h;q?v=new H:(this.container.innerHTML="",w.add(this.container,"loading"));var m=[];this.graphicsLayer=f;f=this.tab.tabLayers[0];var u=this._getFields(f);h=-1===[null,void 0,""].indexOf(f.id)?f.id:this.tab.layers;h=p.getFilter(h,this.parent.opLayers);
a=[];for(d=0;d<e.length;d++)b=new V,b.returnGeometry=!0,b.outSpatialReference=this.parent.map.spatialReference,b.geometry=e[d].buffer,b.where=h,b.outFields=["*"],"undefined"!==typeof f.queryFeatures&&a.push(f.queryFeatures(b));(new K(a)).then(k.hitch(this,function(a){for(var b=0;b<a.length;b++){var c=a[b][1];if(c&&c.features)for(var c=c.features,d=e[b].geometry,f=0;f<c.length;f++){var h=c[f],g=h.geometry,r;if(Array.isArray(d)){var l;for(r=0;r<d.length;r++){var n=p.getDistance(d[r],g,this.parent.config.distanceUnits);
if("undefined"===typeof l||n<l)l=n}r=l;g={DISTANCE:l}}else r=p.getDistance(d,g,this.parent.config.distanceUnits),g={DISTANCE:r};for(n=0;n<u.length;n++)g[u[n]]=h.attributes[u[n]];!0===this.config.csvAllFields||"true"===this.config.csvAllFields?h.attributes.DISTANCE=r:h.attributes=g;m.push(h)}}m.sort(p.compareDistance);if(q){var t={graphics:m,analysisResults:m.length,context:this};this._processResults(m,!0).then(k.hitch(this,function(a){v.resolve(k.mixin(t,a))}))}else this._processResults(m)}),k.hitch(this,
function(a){console.error(a);v.reject(a)}));if(q)return v}},_processResults:function(a,d){var f,h,e=a&&0<a.length;if(e&&"point"!==a[0].geometry.type)for(var b=a.length-1;0<=b;b--)"undefined"===typeof a[b].geometry.getExtent()&&a.splice(b,1);d?f=new H:(this.container.innerHTML="",w.remove(this.container,"loading"),this.graphicsLayer.clear(),e&&(h=z.create("div",{"class":"SAT_tabPanelContent"},this.container),b=z.create("div",{},h),w.add(b,"SATcolExport"),w.add(b,this.parent.lightTheme?"lightThemeBorder":
"darkThemeBorder"),b=z.create("div",{title:this.parent.nls.downloadCSV},b),w.add(b,"btnExport"),F(b,"click",k.hitch(this,this._exportToCSV,a))));var b=this.parent.nls[this.parent.config.distanceUnits],c;"undefined"!==typeof this.tab.advStat&&"undefined"!==typeof this.tab.advStat.stats&&"undefined"!==typeof this.tab.advStat.stats.outFields?c=this.tab.advStat.stats.outFields:(c=[],0<this.tab.tabLayers.length&&G.forEach(this.tab.tabLayers,k.hitch(this,function(a){"undefined"!==typeof a.popupInfo?G.forEach(a.popupInfo.fieldInfos,
k.hitch(this,function(a){if(a.visible){var b={value:0};b.expression=a.fieldName;b.label=a.label;c.push(b)}})):a.infoTemplate?G.forEach(a.infoTemplate.info.fieldInfos,k.hitch(this,function(a){if(a.visible){var b={value:0};b.expression=a.fieldName;b.label=a.label;c.push(b)}})):G.forEach((a.layerObject?a.layerObject:a).fields,k.hitch(this,function(a){var b={value:0};b.expression=a.name;b.label=a.alias;c.push(b)}))})));var g=220,t=[];if(e)for(var v=0;v<a.length;v++){var q=v+1,m=a[v],u=m.geometry,x=u;
"point"!==u.type&&(x=u.getExtent().getCenter());var u=m.attributes,y=p.getDistanceLabel(u.DISTANCE,b,this.parent.nls.approximate),B="",E=0,C=[];if("undefined"!==typeof c){for(var A=0;A<c.length;A++){var D=c[A],r;for(r in u)if("DISTANCE"!==r&&3>E&&D.expression===r){var l=p.getFieldValue(r,u[r],this.specialFields,this.dateFields,"longMonthDayYear",this.typeIdField,this.types,this.layerObject&&this.layerObject.renderer?this.layerObject:this.layerDefinition,u,D),l="undefined"!==typeof l&&null!==l?P.stripHTML(l.toString()):
"",n="undefined"!==typeof D.label&&""!==D.label?D.label:void 0,I=m._layer&&m._layer.fields?m._layer.fields:this.tab.tabLayers&&this.tab.tabLayers[0]?this.tab.tabLayers[0].fields:void 0;I&&"undefined"===typeof n&&(I=p.getField(I,r))&&(n=I.alias);if("undefined"===typeof n||n in[""," ",null,void 0])n=r;p.isURL(l)?l='\x3ca href\x3d"'+l+'" target\x3d"_blank" style\x3d"color: inherit;"\x3e'+n+"\x3c/a\x3e":p.isEmail(l)&&(l='\x3ca href\x3d"mailto:'+l+'" style\x3d"color: inherit;"\x3e'+n+"\x3c/a\x3e");B+=
D.validLabel?("undefined"!==typeof D.label&&""!==D.label?n+" ":"")+l+"\x3cbr/\x3e":l+"\x3cbr/\x3e";E+=1;C.push({label:n,value:l})}}C.push({label:this.parent.nls.distance,value:y});0<C.length&&t.push(C)}d||(m=z.create("div",{},h),w.add(m,"SATcolRec"),w.add(m,this.parent.lightTheme?"lightThemeBorder":"darkThemeBorder"),E=z.create("div",{},m),w.add(E,"SATcolRecBar"),C=z.create("div",{innerHTML:q},E),w.add(C,"SATcolRecNum"),L.set(C,"backgroundColor",this.parent.config.activeColor),F(C,"click",k.hitch(this,
this._zoomToLocation,x)),"point"===this.incidents[0].geometry.type&&(y=z.create("div",{innerHTML:y},E),w.add(y,"SATcolDistance")),this.parent.config.enableRouting&&(y=z.create("div",{title:this.parent.nls.get_directions},E),w.add(y,"SATcolDir"),F(y,"click",k.hitch(this,this._routeToIncident,x))),B=z.create("div",{"class":"SATcolWrap",innerHTML:B},m),w.add(B,"SATcolInfo"),g+=R.position(m).w,B=new O(O.STYLE_SOLID,new J.fromString(this.parent.config.activeMapGraphicColor),1),B=new N(N.STYLE_CIRCLE,24,
B,new J.fromString(this.parent.config.activeMapGraphicColor)),y=new T,y.family="Arial",y.size="12px",q=new U(q,y,new S(this.parent.config.fontColor)),q.setOffset(0,-4),this.graphicsLayer.add(new M(x,B,u)),this.graphicsLayer.add(new M(x,q,u)))}if(!d&&e)L.set(h,"width",g+"px");else return f.resolve({reportResults:t}),f},_exportToCSV:function(a,d,f,h){a=p.exportToCSV(a,d,f,h,{type:"proximity",baseLabel:this.baseLabel,csvAllFields:this.parent.config.csvAllFields,layer:this.tab.tabLayers[0],opLayers:this.parent.opLayers,
nlsValue:this.parent.nls.proximity,nlsCount:this.parent.nls.count,unit:this.parent.nls[this.parent.config.distanceUnits],approximateLabel:this.parent.nls.approximate});this.summaryLayer=a.summaryLayer;return a.details},_getFields:function(a){this.layerDefinition=P.getFeatureLayerDefinition(a);this.layerObject=a;a=p.getFields(a,this.tab,this.allFields,this.parent);this.dateFields=a.dateFields;this.specialFields=a.specialFields;this.typeIdField=a.typeIdField;this.types=a.types;this.displayFields=p.getDisplayFields(this.tab);
return a.fields},_zoomToLocation:function(a){this.parent.zoomToLocation(a)},_routeToIncident:function(a){this.parent.routeToIncident(a)}})});