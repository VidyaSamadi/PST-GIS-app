// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt and http://www.arcgis.com/apps/webappbuilder/copyright.txt for details.
//>>built
define("dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/Deferred jimu/portalUtils jimu/portalUrlUtils jimu/Role esri/request esri/kernel esri/lang ./PortalAnalysis".split(" "),function(p,c,k,d,l,f,q,m,r,n,t){var g=null,h=p([],{userRole:null,userPortalUrl:null,portalAnalysis:null,portalSelf:null,portalUrl:null,licenseDef:null,licenseLevel:null,federatedServers:null,constructor:function(a){this.portalUrl=a},_clearLoadedInfo:function(){this.portalUrl=this.portalSelf=this.portalAnalysis=this.userPortalUrl=
this.userRole=null},loadPrivileges:function(a){a&&this.portalUrl!==a&&(this._clearLoadedInfo(),this.portalUrl=a);if(this._privilegeLoaded())return a=new d,a.resolve(!0),a;a=l.getPortal(this.portalUrl);var b=new d;(a.haveSignIn()?this._loadUserInfo(a):this._signIn(a)).then(c.hitch(this,function(a){a&&this.isPortal()?this.checkAnalysisLicense().then(function(){b.resolve(a)}):b.resolve(a)}));return b},_signIn:function(a){return a.loadSelfInfo().then(c.hitch(this,function(a){var b=l.getPortal(a.portalHostname);
return null===b?!1:b.signIn().then(c.hitch(this,function(a){return this._loadUserInfo(b,a)}),function(){return!1})}),function(){return!1})},_registerOrgCredential:function(a,b){b=f.getStandardPortalUrl(b);a=c.clone(a.toJson());b+="/sharing/rest";a.server=b;a.resources=[b];r.id.registerToken(a)},_loadUserInfo:function(a,b){return a.loadSelfInfo().then(c.hitch(this,function(a){this.userPortalUrl=a.urlKey?a.urlKey+"."+a.customBaseUrl:this.portalUrl;return a&&a.user?(this.userRole=new q({id:a.user.roleId?
a.user.roleId:a.user.role,role:a.user.role}),a.user.privileges&&this.userRole.setPrivileges(a.user.privileges),this.portalSelf=a,b&&this._registerOrgCredential(b,this.userPortalUrl),this.portalAnalysis=new t(this.userRole,this.portalSelf),!0):!1}),function(){return!1})},_privilegeLoaded:function(){return null!==this.portalSelf},getUser:function(){return this._privilegeLoaded()?this.portalSelf.user:null},isAdmin:function(){return this._privilegeLoaded()?this.userRole.isAdmin():!1},getUserPortal:function(){return this._privilegeLoaded()?
this.userPortalUrl:null},isPortal:function(){return null!==this.portalSelf&&!0===this.portalSelf.isPortal},canPerformAnalysis:function(){return null!==this.portalAnalysis&&this.portalAnalysis.canPerformAnalysis()},canPerformSpatialAnalytics:function(){return null!==this.portalAnalysis&&this.portalAnalysis.canPerformSpatialAnalytics()},canPerformGeoAnalytics:function(){return null!==this.portalAnalysis&&this.portalAnalysis.canPerformGeoAnalytics()},canPerformRasterAnalysis:function(){return null!==
this.portalAnalysis&&this.portalAnalysis.canPerformRasterAnalysis()},canPerformGeoEnrichment:function(){return null!==this.portalAnalysis&&this.portalAnalysis._canPerformGeoEnrichment()},hasPrivileges:function(a){var b=a,e=!1;c.isArray(a)&&0<=a.indexOf("svradvanced")&&(e=!0,b=k.filter(a,function(a){return"svradvanced"!==a}));return e&&this.isPortal()?this.isAdvanceLicense()&&null!==this.portalAnalysis&&this.portalAnalysis.hasPrivileges(b):null!==this.portalAnalysis&&this.portalAnalysis.hasPrivileges(b)},
isAdvanceLicense:function(){return"svradvanced"===this.licenseLevel},getFederatedServers:function(){var a=new d;if(this.isPortal()&&this.userRole&&!this.federatedServers){var b=f.getSharingUrl(this.portalUrl)+"/portals/"+this.portalSelf.id+"/servers";m({url:b,content:{f:"json"}}).then(c.hitch(this,function(b){this.federatedServers=b.servers;a.resolve(this.federatedServers)}),c.hitch(this,function(b){console.log("cannot load federated servers",b);this.federatedServers=[];a.resolve([])}))}else a.resolve(this.federatedServers);
return a},getLicense:function(a){var b=new d,e;if(0===a.length)return b.resolve(null),b;a=k.filter(a,function(a){return"HOSTING_SERVER"===a.serverRole},this);0<a.length&&(e=a[0]);a=f.getSharingUrl(this.portalUrl);m({url:a+"/portals/"+this.portalSelf.id+"/servers/"+e.id,content:{f:"json"}}).then(c.hitch(this,function(a){var d=c.mixin({},a);a=n.isDefined(a.edition)||n.isDefined(a.level)?null:"svradvanced";this.licenseLevel=d.edition?d.edition.name:a;b.resolve({licenseInfo:d,licenseLevel:this.licenseLevel})}),
c.hitch(this,function(a){console.log("cannot load hostingServer info",a);b.resolve({})}));return b},checkAnalysisLicense:function(){var a=new d;this.licenseDef?this.licenseDef.isResolved()?a.resolve("svradvanced"===this.licenseLevel):this.licenseDef.then(c.hitch(this,function(){a.resolve("svradvanced"===this.licenseLevel)})):(this.licenseDef=this.getFederatedServers().then(c.hitch(this,function(a){return this.getLicense(a)})),this.licenseDef.then(c.hitch(this,function(){return a.resolve("svradvanced"===
this.licenseLevel)})));return a}});h.getInstance=function(a){null===g&&(g=new h(a));return g};return h});