// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt and http://www.arcgis.com/apps/webappbuilder/copyright.txt for details.
//>>built
define("esri/request dojo/json dojo/topic dojo/_base/lang dojo/_base/array esri/IdentityManager esri/arcgis/Portal esri/layers/FeatureLayer esri/graphic jimu/LayerInfos/LayerInfos".split(" "),function(n,l,f,b,v,p,r,u,w,t){return{saveToPortal:function(a,e,c,m,h,g,n){p.registerOAuthInfos();p.getCredential(c.portalUrl+"/sharing",{oAuthPopupConfirmation:!1}).then(b.hitch(this,function(){(new r.Portal(c.portalUrl)).signIn().then(b.hitch(this,function(d){var q=d.credential.token,l=d.orgId,p=d.username;
if("org_user"===d.role)h.innerHTML=g.createService.format(g.userRole);else{var r=c.portalUrl+"sharing/content/users/"+p+"/createService";this.isNameAvailable(c.portalUrl+"sharing/rest/portals/"+l+"/isServiceNameAvailable",q,a).then(b.hitch(this,function(d){d.available?(f.publish("setBusyIndicator",!0),this.createFeatureService(r,q,this.getFeatureServiceParams(a,e)).then(b.hitch(this,function(d){if(d.success){var l=d.serviceurl.replace(/rest/g,"rest/admin")+"/addToDefinition";this.addDefinitionToService(l,
q,this.getLayerParams(a,e,m,g)).then(b.hitch(this,function(k){if(k.success){k=new u(d.serviceurl+"/0?token\x3d"+q,{id:a,outFields:["*"]});k._wabProperties={itemLayerInfo:{portalUrl:c.portalUrl,itemId:d.itemId}};e.addLayer(k);var m;if(k.loaded)m=t.getInstanceSync().getLayerInfoById(a),m.enablePopup();else k.on("load",b.hitch(this,function(){m=t.getInstanceSync().getLayerInfoById(a);m.enablePopup()}));k.applyEdits(n,null,null).then(b.hitch(this,function(){f.publish("clear")})).otherwise(b.hitch(this,
function(){f.publish("clear")}));f.publish("setBusyIndicator",!1);h.innerHTML=g.successfullyPublished.format('\x3cbr /\x3e\x3ca href\x3d"'+c.portalUrl+"home/item.html?id\x3d"+d.itemId+'" target\x3d"_blank"\x3e')+"\x3c/a\x3e"}}),b.hitch(this,function(a){f.publish("setBusyIndicator",!1);h.innerHTML=g.addToDefinition.format(a.message)}))}else f.publish("setBusyIndicator",!1),h.innerHTML=g.unableToCreate.format(a)}),b.hitch(this,function(a){f.publish("setBusyIndicator",!1);h.innerHTML=g.createService.format(a.message)}))):
(f.publish("setBusyIndicator",!1),h.innerHTML=g.publishingFailedLayerExists.format(a))}),b.hitch(this,function(a){f.publish("setBusyIndicator",!1);h.innerHTML=g.checkService.format(a.message)}))}}),b.hitch(this,function(a){h.innerHTML=a.message}))}))},getFeatureServiceParams:function(a,e){return{name:a,serviceDescription:"",hasStaticData:!1,maxRecordCount:1E3,supportedQueryFormats:"JSON",capabilities:"Create,Delete,Query,Update,Editing",tags:"ThreatAnalysis",description:"",copyrightText:"",spatialReference:{wkid:102100},
initialExtent:{xmin:e.extent.xmin,ymin:e.extent.ymin,xmax:e.extent.xmax,ymax:e.extent.ymax,spatialReference:{wkid:102100}},allowGeometryUpdates:!0,units:"esriMeters",xssPreventionInfo:{xssPreventionEnabled:!0,xssPreventionRule:"InputOnly",xssInputRule:"rejectInvalid"}}},getLayerParams:function(a,e,c,b){return{layers:[{adminLayerInfo:{geometryField:{name:"Shape"},xssTrustedFields:""},id:0,name:a,type:"Feature Layer",displayField:"",description:"",tags:"ThreatAnalysis",copyrightText:"",defaultVisibility:!0,
ownershipBasedAccessControlForFeatures:{allowOthersToQuery:!1,allowOthersToDelete:!1,allowOthersToUpdate:!1},relationships:[],isDataVersioned:!1,supportsCalculate:!0,supportsAttachmentsByUploadId:!0,supportsRollbackOnFailureParameter:!0,supportsStatistics:!0,supportsAdvancedQueries:!0,supportsValidateSql:!0,supportsCoordinatesQuantization:!0,supportsApplyEditsWithGlobalIds:!0,advancedQueryCapabilities:{supportsPagination:!0,supportsQueryWithDistance:!0,supportsReturningQueryExtent:!0,supportsStatistics:!0,
supportsOrderBy:!0,supportsDistinct:!0,supportsQueryWithResultType:!0,supportsSqlExpression:!0,supportsReturningGeometryCentroid:!0},useStandardizedQueries:!1,geometryType:"esriGeometryPolygon",minScale:0,maxScale:0,extent:e.extent,drawingInfo:{renderer:c.toJson(),transparency:0},allowGeometryUpdates:!0,hasAttachments:!1,htmlPopupType:"esriServerHTMLPopupTypeNone",hasM:!1,hasZ:!1,objectIdField:"OBJECTID",globalIdField:"",typeIdField:"",fields:[{name:"OBJECTID",type:"esriFieldTypeOID",actualType:"int",
alias:"OBJECTID",sqlType:"sqlTypeOther",nullable:!1,editable:!1,domain:null,defaultValue:null},{name:"zone_type",type:"esriFieldTypeString",alias:b.zoneTypeLabel,actualType:"nvarchar",nullable:!0,editable:!0,domain:null,defaultValue:null,sqlType:"sqlTypeNVarchar",length:256},{name:"threat_type",type:"esriFieldTypeString",alias:b.threatType,actualType:"nvarchar",nullable:!0,editable:!0,domain:null,defaultValue:null,sqlType:"sqlTypeNVarchar",length:256},{name:"mandatory_dist",type:"esriFieldTypeDouble",
alias:b.mandatoryLabel,actualType:"float",nullable:!0,editable:!0,domain:null,defaultValue:null,sqlType:"sqlTypeFloat"},{name:"safe_dist",type:"esriFieldTypeDouble",alias:b.safeLabel,actualType:"float",nullable:!0,editable:!0,domain:null,defaultValue:null,sqlType:"sqlTypeFloat"},{name:"units",type:"esriFieldTypeString",alias:b.unitsLabel,actualType:"nvarchar",nullable:!0,editable:!0,domain:null,defaultValue:null,sqlType:"sqlTypeNVarchar",length:256}],indexes:[],types:[],templates:[{name:"New Feature",
description:"",drawingTool:"esriFeatureEditToolPolygon",prototype:{attributes:{type:""}}}],supportedQueryFormats:"JSON",hasStaticData:!1,maxRecordCount:1E4,standardMaxRecordCount:4E3,tileMaxRecordCount:4E3,maxRecordCountFactor:1,exceedsLimitFactor:1,capabilities:"Query,Editing,Create,Update,Delete"}]}},isNameAvailable:function(a,b,c){return n({url:a,content:{name:c,type:"Feature Service",token:b,f:"json"},handleAs:"json",callbackParamName:"callback"},{usePost:!0})},createFeatureService:function(a,
b,c){return n({url:a,content:{f:"json",token:b,typeKeywords:"ArcGIS Server,Data,Feature Access,Feature Service,Service,Hosted Service",createParameters:l.stringify(c),outputType:"featureService"},handleAs:"json",callbackParamName:"callback"},{usePost:!0})},addDefinitionToService:function(a,b,c){return n({url:a,content:{token:b,addToDefinition:l.stringify(c),f:"json"},handleAs:"json",callbackParamName:"callback"},{usePost:!0})}}});